<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBPS-DB</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f8f9fa; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #e9ecef; }
        tr:nth-child(even) { background: #f1f3f4; }
        .icon { width: 48px; height: 48px; object-fit: contain; }
        .download-btn { background: #0976d7; color: #fff; padding: 0.3em 0.8em; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .download-btn:hover { background: #064785; }
    </style>
</head>
<body>
    <h1>CBPS-DB</h1>
    <table id="cbps-table">
        <thead>
        <tr>
            <th>Icon</th>
            <th>Name</th>
            <th>Author</th>
            <th>Type</th>
            <th>Download</th>
            <th>README</th>
        </tr>
        </thead>
        <tbody>
        <!-- Data will be inserted here -->
        </tbody>
    </table>
    <script>
        const CSV_URL = "https://raw.githubusercontent.com/SSMG4/cbps-db/refs/heads/master/cbpsdb.csv";

        function parseCSV(csv) {
            // Remove BOM if present
            if (csv.charCodeAt(0) === 0xfeff) csv = csv.slice(1);
            const lines = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
            const headers = lines[0].split(",");
            return lines.slice(1).map(line => {
                // Handle quoted values and commas inside quotes
                const values = [];
                let current = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; ++i) {
                    const c = line[i];
                    if (c === '"') {
                        if (inQuotes && line[i+1] === '"') { current += '"'; ++i; }
                        else inQuotes = !inQuotes;
                    } else if (c === ',' && !inQuotes) {
                        values.push(current);
                        current = "";
                    } else {
                        current += c;
                    }
                }
                values.push(current);
                const obj = {};
                for (let j = 0; j < headers.length; ++j) {
                    obj[headers[j].trim()] = (values[j] || "").trim();
                }
                return obj;
            });
        }

        function createDownloadLink(url, name) {
            if (!url || url === "None") return '';
            return `<a class="download-btn" href="${url}" download="${encodeURIComponent(name)}.vpk">Download</a>`;
        }

        function createReadmeLink(url) {
            if (!url || url === "None") return '';
            return `<a href="${url}" target="_blank">README</a>`;
        }

        function createIcon(url, name) {
            if (!url || url === "None") return '';
            return `<img class="icon" src="${url}" alt="icon of ${name}">`;
        }

        fetch(CSV_URL)
            .then(r => {
                if (!r.ok) throw new Error("Failed to fetch CSV");
                return r.text();
            })
            .then(csv => {
                const data = parseCSV(csv);
                const tbody = document.querySelector("#cbps-table tbody");
                tbody.innerHTML = "";
                data.forEach(row => {
                    // Prefer download_url, fallback to download_url_mirror
                    const dlUrl = row["download_url"] !== "None" && row["download_url"] ? row["download_url"] : (row["download_url_mirror"] !== "None" ? row["download_url_mirror"] : "");
                    const iconUrl = row["download_icon0"] !== "None" && row["download_icon0"] ? row["download_icon0"] : "";
                    const readmeUrl = row["download_readme"] !== "None" && row["download_readme"] ? row["download_readme"] : "";

                    // Only show if visible is True (some rows may be hidden)
                    if (row["visible"] && row["visible"].toLowerCase() !== "true") return;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${createIcon(iconUrl, row["title"] || "")}</td>
                        <td>${row["title"] || ""}</td>
                        <td>${row["credits"] || ""}</td>
                        <td>${row["type"] || ""}</td>
                        <td>${createDownloadLink(dlUrl, row["title"] || "download")}</td>
                        <td>${createReadmeLink(readmeUrl)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                document.querySelector("#cbps-table tbody").innerHTML = `<tr><td colspan="6" style="color:red;">Error loading CBPS DB: ${err.message}</td></tr>`;
            });
    </script>
</body>
</html>
