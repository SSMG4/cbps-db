<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBPS-DB</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 2em; 
            background: #181a1b; 
            color: #f5f5f5;
        }
        h1 { 
            text-align: center; 
            color: #fff; 
            cursor: pointer;
            transition: color 0.18s;
        }
        h1:hover { color: #ffd86c; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 2em; 
            background: #23292d;
            color: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td { 
            border: 1px solid #35393b; 
            padding: 0.5em; 
            text-align: left; 
        }
        th { 
            background: #37404a; 
            color: #ffd86c;
        }
        tr:nth-child(even) { background: #23292d; }
        tr:nth-child(odd) { background: #202426; }
        .icon { width: 48px; height: 48px; object-fit: contain; background: #222; border-radius: 5px; }
        .download-btn { 
            background: #0976d7; 
            color: #fff; 
            padding: 0.3em 0.8em; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            text-decoration: none;
            font-weight: bold;
            transition: background 0.15s;
        }
        .download-btn:hover { background: #064785; color: #ffd86c; }
        a { color: #4eaaff; }
        a:hover { color: #ffd86c; }
        .src-open { color: #8cff8c; font-weight: bold; }
        .src-closed { color: #ff7c7c; font-weight: bold; }
        .footer-credits {
            position: fixed;
            right: 18px;
            bottom: 8px;
            font-size: 0.98em;
            color: #777;
            z-index: 9999;
            user-select: none;
        }
        .footer-credits a {
            color: #ffd86c;
            text-decoration: underline;
            font-weight: bold;
            transition: color 0.15s;
        }
        .footer-credits a:hover {
            color: #4eaaff;
        }
        .nav-menu {
            text-align: center;
            margin-bottom: 14px;
        }
        .nav-menu a {
            color: #ffd86c;
            text-decoration: underline;
            font-size: 1.08em;
            font-weight: bold;
            margin: 0 24px;
            transition: color 0.15s;
        }
        .nav-menu .active, .nav-menu a:hover {
            color: #4eaaff;
        }
    </style>
</head>
<body>
    <div class="nav-menu">
        <a href="cbps-db2.html" class="active">Apps</a>
        <a href="plugins.html">Plugins</a>
        <a href="submit.html">Submit</a>
    </div>
    <h1 onclick="window.location.href='https://ssmg4.github.io/cbps-db/'">CBPS-DB</h1>
    <table id="cbps-table">
        <thead>
        <tr>
            <th>Icon</th>
            <th>Name</th>
            <th>Author</th>
            <th>Type</th>
            <th>Download</th>
            <th>README</th>
            <th>SRC</th>
        </tr>
        </thead>
        <tbody>
        <!-- Data will be inserted here -->
        </tbody>
    </table>
    <span class="footer-credits">
        &copy; 2025 <a href="https://github.com/SSMG4" target="_blank">SSMG4</a> &amp; <a href="https://github.com/copilot" target="_blank">GitHub Copilot</a>
    </span>
    <script>
        const CSV_URL = "https://raw.githubusercontent.com/SSMG4/cbps-db/refs/heads/master/cbpsdb.csv";

        function parseCSV(csv) {
            // Remove BOM if present
            if (csv.charCodeAt(0) === 0xfeff) csv = csv.slice(1);
            const lines = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
            const headers = lines[0].split(",");
            return lines.slice(1).map(line => {
                // Handle quoted values and commas inside quotes
                const values = [];
                let current = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; ++i) {
                    const c = line[i];
                    if (c === '"') {
                        if (inQuotes && line[i+1] === '"') { current += '"'; ++i; }
                        else inQuotes = !inQuotes;
                    } else if (c === ',' && !inQuotes) {
                        values.push(current);
                        current = "";
                    } else {
                        current += c;
                    }
                }
                values.push(current);
                const obj = {};
                for (let j = 0; j < headers.length; ++j) {
                    obj[headers[j].trim()] = (values[j] || "").trim();
                }
                return obj;
            });
        }

        function createDownloadLink(url, name) {
            if (!url || url === "None") return '';
            return `<a class="download-btn" href="${url}" download="${encodeURIComponent(name)}.vpk">Download</a>`;
        }

        function createReadmeLink(url) {
            if (!url || url === "None") return '';
            return `<a href="${url}" target="_blank">README</a>`;
        }

        function createIcon(url, name) {
            if (!url || url === "None") return '';
            return `<img class="icon" src="${url}" alt="icon of ${name}">`;
        }

        function getSrcStatus(url) {
            if (!url) return '';
            return url.startsWith("https://files.cbps.xyz") ? 
                `<span class="src-closed">CLOSED SRC</span>` :
                `<span class="src-open">OPEN SRC</span>`;
        }

        // Only show Apps/VPKs (not plugins/data)
        function isApp(row) {
            // Types for apps/vpks: VPK, APP, or if type is blank and not plugin/data
            const t = (row["type"] || "").toUpperCase();
            if (t === "VPK" || t === "APP") return true;
            // Exclude plugins/data
            if (t === "SKPRX" || t === "SUPRX" || t === "PLUGIN" || t === "DATA") return false;
            // Heuristic: if title mentions "plugin" or "data", skip
            if ((row["title"] || "").toLowerCase().includes("plugin")) return false;
            if ((row["title"] || "").toLowerCase().includes("data")) return false;
            return true;
        }

        fetch(CSV_URL)
            .then(r => {
                if (!r.ok) throw new Error("Failed to fetch CSV");
                return r.text();
            })
            .then(csv => {
                const data = parseCSV(csv);
                const tbody = document.querySelector("#cbps-table tbody");
                tbody.innerHTML = "";
                data.forEach(row => {
                    // Only show if visible is True (some rows may be hidden)
                    if (row["visible"] && row["visible"].toLowerCase() !== "true") return;
                    if (!isApp(row)) return;

                    // Prefer download_url, fallback to download_url_mirror
                    const dlUrl = row["download_url"] !== "None" && row["download_url"] ? row["download_url"] : (row["download_url_mirror"] !== "None" ? row["download_url_mirror"] : "");
                    const iconUrl = row["download_icon0"] !== "None" && row["download_icon0"] ? row["download_icon0"] : "";
                    const readmeUrl = row["download_readme"] !== "None" && row["download_readme"] ? row["download_readme"] : "";

                    // Determine SRC status
                    const srcStatus = getSrcStatus(dlUrl);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${createIcon(iconUrl, row["title"] || "")}</td>
                        <td>${row["title"] || ""}</td>
                        <td>${row["credits"] || ""}</td>
                        <td>${row["type"] || ""}</td>
                        <td>${createDownloadLink(dlUrl, row["title"] || "download")}</td>
                        <td>${createReadmeLink(readmeUrl)}</td>
                        <td style="text-align:right;">${srcStatus}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                document.querySelector("#cbps-table tbody").innerHTML = `<tr><td colspan="7" style="color:red;">Error loading CBPS DB: ${err.message}</td></tr>`;
            });
    </script>
</body>
</html>
