<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBPS-DB App & Plugin Browser</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f8f9fa; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #e9ecef; }
        tr:nth-child(even) { background: #f1f3f4; }
        .type-app { color: #0976d7; font-weight: bold; }
        .type-plugin { color: #be1e37; font-weight: bold; }
        .download-btn { background: #0976d7; color: #fff; padding: 0.3em 0.8em; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .download-btn:hover { background: #064785; }
    </style>
</head>
<body>
    <h1>CBPS-DB App & Plugin Browser</h1>
    <table id="cbps-table">
        <thead>
        <tr>
            <th>Name</th>
            <th>Author</th>
            <th>Type</th>
            <th>Version</th>
            <th>Description</th>
            <th>Download</th>
        </tr>
        </thead>
        <tbody>
        <!-- Data will be inserted here -->
        </tbody>
    </table>
    <script>
        const CSV_URL = "https://raw.githubusercontent.com/SSMG4/cbps-db/refs/heads/master/cbpsdb.csv";

        // Helper function to parse CSV to objects (simple, assumes no commas inside values)
        function parseCSV(csv) {
            // Remove BOM if present
            if (csv.charCodeAt(0) === 0xfeff) csv = csv.slice(1);
            const lines = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
            const headers = lines[0].split(",");
            return lines.slice(1).map(line => {
                // Handle quoted values and commas inside quotes
                const values = [];
                let current = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; ++i) {
                    const c = line[i];
                    if (c === '"') {
                        if (inQuotes && line[i+1] === '"') { current += '"'; ++i; }
                        else inQuotes = !inQuotes;
                    } else if (c === ',' && !inQuotes) {
                        values.push(current);
                        current = "";
                    } else {
                        current += c;
                    }
                }
                values.push(current);
                const obj = {};
                for (let j = 0; j < headers.length; ++j) {
                    obj[headers[j].trim()] = (values[j] || "").trim();
                }
                return obj;
            });
        }

        function createDownloadLink(url, name) {
            if (!url) return '';
            return `<a class="download-btn" href="${url}" download="${encodeURIComponent(name)}">Download</a>`;
        }

        fetch(CSV_URL)
            .then(r => {
                if (!r.ok) throw new Error("Failed to fetch CSV");
                return r.text();
            })
            .then(csv => {
                const data = parseCSV(csv);
                // Heuristics: Type column may be called "Type", "type", or similar - fallback to "App/Plugin"
                const typeKey = ["Type", "type", "App/Plugin"].find(k => data[0] && k in data[0]) || "Type";
                const nameKey = ["Name", "name", "Title"].find(k => data[0] && k in data[0]) || "Name";
                const authorKey = ["Author", "author", "By"].find(k => data[0] && k in data[0]) || "Author";
                const versionKey = ["Version", "version", "Ver"].find(k => data[0] && k in data[0]) || "Version";
                const descKey = ["Description", "description", "Desc"].find(k => data[0] && k in data[0]) || "Description";
                const urlKey = ["URL", "url", "Download"].find(k => data[0] && k in data[0]) || "URL";

                // Sort: apps first, then plugins (or just show all)
                const tbody = document.querySelector("#cbps-table tbody");
                tbody.innerHTML = "";
                data.forEach(row => {
                    const type = (row[typeKey] || "").toLowerCase();
                    const typeClass = type.includes("plugin") ? "type-plugin" : "type-app";
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row[nameKey] || ""}</td>
                        <td>${row[authorKey] || ""}</td>
                        <td class="${typeClass}">${row[typeKey] || ""}</td>
                        <td>${row[versionKey] || ""}</td>
                        <td>${row[descKey] || ""}</td>
                        <td>${createDownloadLink(row[urlKey], row[nameKey] || "download")}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                document.querySelector("#cbps-table tbody").innerHTML = `<tr><td colspan="6" style="color:red;">Error loading CBPS DB: ${err.message}</td></tr>`;
            });
    </script>
</body>
</html>
